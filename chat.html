<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <!-- Add custom Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container {
            height: calc(100vh - 240px);
        }
        .messages-container {
            height: calc(100% - 160px);
            overflow-y: auto;
        }
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-800 to-gray-900 text-gray-100" onload="checkAuth()">
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6 bg-gray-800 p-4 rounded-lg shadow-lg">
        <div class="flex items-center space-x-3">
            <div class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center font-bold text-xl" id="userInitial"></div>
            <div>
                <h1 class="text-2xl font-bold">Quantum Chat</h1>
                <p class="text-sm text-gray-400" id="userDisplay"></p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <div id="connectionStatus" class="flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                <span class="text-sm text-gray-400">Connected</span>
            </div>
            <button onclick="logout()"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200">
                Logout
            </button>
        </div>
    </div>

    <!-- Protocol Initialization (Only for Alice) -->
    <div id="initSection" class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6" style="display: none;">
        <h2 class="text-xl font-semibold mb-4 text-indigo-400">Initialize Quantum Channel</h2>
        <form id="initForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300">Number of Bits</label>
                <input type="number" id="bitsInput" value="256" min="128" max="1024"
                       class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-lg text-gray-100">
            </div>
            <button type="submit"
                    class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                Initialize Protocol
            </button>
        </form>
        <div id="status" class="mt-4 text-sm text-gray-400"></div>
    </div>

    <!-- Chat Area -->
    <div class="chat-container bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <!-- Messages -->
        <div class="messages-container p-6" id="messages">
            <!-- Messages will be loaded here -->
        </div>

        <!-- Message Input -->
        <div class="p-4 bg-gray-900">
            <form id="messageForm" class="flex items-end space-x-4">
                <div class="flex-grow">
                        <textarea id="messageInput"
                                  class="w-full bg-gray-700 border-gray-600 rounded-lg text-gray-100 resize-none"
                                  rows="3"
                                  placeholder="Type your message..."></textarea>
                </div>
                <button type="submit"
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200 flex-shrink-0">
                    Send
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    let currentUser = '';

    function checkAuth() {
        currentUser = localStorage.getItem('quantum_user');
        if (!currentUser) {
            window.location.href = '/index.html';
            return;
        }

        document.getElementById('userDisplay').textContent = `Logged in as ${currentUser}`;
        document.getElementById('userInitial').textContent = currentUser[0];

        if (currentUser === 'Alice') {
            document.getElementById('initSection').style.display = 'block';
        }
    }

    function logout() {
        localStorage.removeItem('quantum_user');
        window.location.href = '/index.html';
    }

    document.getElementById('initForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const bits = document.getElementById('bitsInput').value;
        try {
            const response = await fetch('http://localhost:8080/initialize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ bits: parseInt(bits) })
            });
            const data = await response.json();
            document.getElementById('status').innerHTML =
                `<span class="text-green-400">✓ Protocol initialized successfully</span>`;
        } catch (error) {
            document.getElementById('status').innerHTML =
                `<span class="text-red-400">✗ Error: ${error.message}</span>`;
        }
    });

    document.getElementById('messageForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const plaintext = document.getElementById('messageInput').value;
        if (!plaintext.trim()) return;

        await sendMessage(plaintext, currentUser);
        document.getElementById('messageInput').value = '';
    });

    async function sendMessage(plaintext, sender) {
        try {
            const response = await fetch('http://localhost:8080/encrypt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ plaintext, sender })
            });
            if (!response.ok) {
                throw new Error('Failed to send message');
            }
            await fetchMessages();
        } catch (error) {
            console.error('Error sending message:', error);
        }
    }

    async function fetchMessages() {
        try {
            const response = await fetch('http://localhost:8080/messages');
            if (!response.ok) {
                throw new Error('Failed to fetch messages');
            }
            const data = await response.json();

            // For each encrypted message, decrypt it if we're the recipient
            const decryptedMessages = await Promise.all(data.messages.map(async (msg) => {
                if (msg.sender !== currentUser) {
                    try {
                        const decryptResponse = await fetch('http://localhost:8080/decrypt', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ ciphertext: msg.ciphertext })
                        });
                        const decryptData = await decryptResponse.json();
                        return {
                            ...msg,
                            decryptedText: decryptData.plaintext
                        };
                    } catch (error) {
                        console.error('Decryption error:', error);
                        return msg;
                    }
                }
                return msg;
            }));

            displayMessages(decryptedMessages);
        } catch (error) {
            console.error('Error fetching messages:', error);
        }
    }

    function displayMessages(messages) {
        const messagesDiv = document.getElementById('messages');
        if (!messages) return;

        messagesDiv.innerHTML = messages.map(msg => {
            const isSender = msg.sender === currentUser;
            const messageContent = isSender ?
                '<span class="text-gray-300">Message sent</span>' :
                msg.decryptedText;

            return `
                    <div class="mb-4 flex ${isSender ? 'justify-end' : 'justify-start'}">
                        <div class="message-bubble ${isSender ? 'bg-indigo-600' : 'bg-gray-700'} rounded-lg p-4">
                            <div class="text-sm text-gray-300 mb-1">${msg.sender}</div>
                            <div class="text-gray-100">${messageContent}</div>
                        </div>
                    </div>
                `;
        }).join('');

        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Fetch messages periodically
    setInterval(fetchMessages, 1000);
    fetchMessages(); // Initial fetch
</script>
</body>
</html>